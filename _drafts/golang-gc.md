---
title: Go 垃圾收集
author:
  name: Jugg Wang
  link: https://github.com/kekaiwang
date: 2022-01-19 11:20:00 +0800
categories: [Go, GC]
tags: [go, gc, 垃圾收集]
# img_path: /assets/_img/mysql/index
---

## 垃圾收集简介

### 三色标记法

**悬挂指针**，即指针没有指向特定类型的合法对象，影响了内存的安全性。

### 屏障技术

- **强三色不变性** — 黑色对象不会指向白色对象，只会指向灰色对象或者黑色对象；
- **弱三色不变性** — 黑色对象指向的白色对象必须包含一条从灰色对象经由多个白色对象的可达路径

#### 插入写屏障

**将有存活可能的对象都标记成灰色以满足强三色不变性**。

因为栈上的对象在垃圾收集中也会被认为是根对象，所以为了保证内存的安全，Dijkstra 必须为栈上的对象增加写屏障或者在标记阶段完成重新对栈上的对象进行扫描，这两种方法各有各的缺点，前者会大幅度增加写入指针的额外开销，后者重新扫描栈对象时需要暂停程序，垃圾收集算法的设计者需要在这两者之间做出权衡。

#### 删除写屏障

### 增量&并发

## 垃圾收集开始

### 根对象都是什么？

1. **全局变量**：程序在编译期就能确定的那些存在于程序整个生命周期的变量。
2. **执行栈**：每个 goroutine 都包含自己的执行栈，这些执行栈上包含栈上的变量及指向分配的堆内存区块的指针。
3. **寄存器**：寄存器的值可能表示一个指针，参与计算的这些指针可能指向某些赋值器分配的堆内存区块。

**在垃圾收集的标记阶段，我们还需要将创建的所有新对象都标记成黑色**。

